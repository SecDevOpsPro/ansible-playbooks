---
# Common role - System requirements check and base setup

- name: Check minimum system requirements
  ansible.builtin.assert:
    that:
      - ansible_memtotal_mb >= 512
      - ansible_processor_vcpus >= 1
    fail_msg: "Minimum requirements: 1 CPU core and 512MB RAM"
    success_msg: "System requirements met"

- name: Set timezone
  community.general.timezone:
    name: "{{ timezone | default('UTC') }}"

- name: Update package cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- name: Install common packages
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop: "{{ common_packages }}"
  when: common_packages is defined

- name: Install apt packages
  ansible.builtin.apt:
    name: "{{ common_apt_packages }}"
    state: present
    autoclean: true
    install_recommends: false
  when:
    - ansible_os_family == "Debian"
    - apt_packages is defined
    - apt_packages | length > 0

- name: Install pip packages
  ansible.builtin.pip:
    name: "{{ common_pip_packages }}"
    state: present
  when:
    - pip_packages is defined
    - pip_packages | length > 0

- name: Configure NTP (chrony)
  ansible.builtin.apt:
    name: chrony
    state: present
  when: ansible_os_family == "Debian"

- name: Start and enable chrony
  ansible.builtin.service:
    name: chrony
    state: started
    enabled: true

- name: Configure system limits
  community.general.pam_limits:
    domain: "{{ item.domain }}"
    limit_type: "{{ item.type }}"
    limit_item: "{{ item.item }}"
    value: "{{ item.value }}"
  loop: "{{ system_limits | default([]) }}"
  when: system_limits is defined

- name: Ensure hostname is set
  ansible.builtin.hostname:
    name: "{{ inventory_hostname_short }}"
  when: inventory_hostname_short is defined

- name: Update /etc/hosts with hostname
  ansible.builtin.lineinfile:
    path: /etc/hosts
    regexp: '^127\.0\.1\.1'
    line: "127.0.1.1 {{ inventory_hostname_short }}"
    state: present
  when: inventory_hostname_short is defined
