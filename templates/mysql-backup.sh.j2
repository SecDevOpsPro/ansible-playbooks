# MySQL Backup Script
# Generated by Ansible - DO NOT EDIT MANUALLY
#!/bin/bash

set -euo pipefail

# Configuration
BACKUP_DIR="{{ mysql_backup_dir | default('/var/backups/mysql') }}"
RETENTION_DAYS="{{ mysql_backup_retention_days | default(7) }}"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/mysql-backup-${TIMESTAMP}.sql.gz"

# Ensure backup directory exists
mkdir -p "${BACKUP_DIR}"

# Create backup
echo "[$(date)] Starting MySQL backup..."
mysqldump --all-databases \
    --single-transaction \
    --quick \
    --lock-tables=false \
    --routines \
    --triggers \
    --events \
    | gzip > "${BACKUP_FILE}"

# Set permissions
chmod 600 "${BACKUP_FILE}"

# Remove old backups
echo "[$(date)] Removing backups older than ${RETENTION_DAYS} days..."
find "${BACKUP_DIR}" -name "mysql-backup-*.sql.gz" -mtime +${RETENTION_DAYS} -delete

# Log completion
BACKUP_SIZE=$(du -h "${BACKUP_FILE}" | cut -f1)
echo "[$(date)] Backup completed: ${BACKUP_FILE} (${BACKUP_SIZE})"

# Count remaining backups
BACKUP_COUNT=$(find "${BACKUP_DIR}" -name "mysql-backup-*.sql.gz" | wc -l)
echo "[$(date)] Total backups retained: ${BACKUP_COUNT}"

exit 0
