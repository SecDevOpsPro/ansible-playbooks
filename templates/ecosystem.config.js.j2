// PM2 Ecosystem Configuration
// Generated by Ansible - DO NOT EDIT MANUALLY
// Template: ecosystem.config.js.j2

module.exports = {
  apps: [{
    name: '{{ app_name | default("nodejs-app") }}',
    script: '{{ app_script | default("server.js") }}',
    cwd: '{{ app_path | default("/opt/nodejs-app") }}',
    instances: {{ pm2_instances | default("max") }},
    exec_mode: '{{ pm2_exec_mode | default("cluster") }}',
    watch: {{ pm2_watch | default("false") | lower }},
    max_memory_restart: '{{ pm2_max_memory | default("1G") }}',
    env: {
      NODE_ENV: 'production',
      PORT: {{ app_port | default(3000) }},
{% if db_host is defined %}
      DB_HOST: '{{ db_host }}',
{% endif %}
{% if db_name is defined %}
      DB_NAME: '{{ db_name }}',
{% endif %}
{% if db_user is defined %}
      DB_USER: '{{ db_user }}',
{% endif %}
{% if db_password is defined %}
      DB_PASSWORD: '{{ db_password }}',
{% endif %}
{% if redis_host is defined %}
      REDIS_HOST: '{{ redis_host }}',
{% endif %}
{% if redis_port is defined %}
      REDIS_PORT: {{ redis_port }},
{% endif %}
    },
    error_file: '{{ app_log_dir | default("/var/log/nodejs-app") }}/error.log',
    out_file: '{{ app_log_dir | default("/var/log/nodejs-app") }}/output.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    min_uptime: '10s',
    max_restarts: 10,
    restart_delay: 4000,
    kill_timeout: 5000,
    listen_timeout: 3000,
    shutdown_with_message: true
  }]
};
