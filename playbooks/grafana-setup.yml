---
# Grafana Setup Playbook
# Description: Install and configure Grafana dashboard server
# Tested on: Ubuntu 20.04/22.04, Debian 11
# Author: SecDevOpsPro

- name: Setup Grafana Dashboard Server
  hosts: monitoring
  become: true
  gather_facts: true

  vars:
    grafana_version: "latest"
    grafana_port: 3000
    grafana_admin_user: admin
    grafana_admin_password: "{{ vault_grafana_admin_password | default('admin') }}"

  tasks:
    - name: Install Grafana dependencies
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - software-properties-common
          - wget
        state: present
        update_cache: true

    - name: Add Grafana GPG key
      ansible.builtin.apt_key:
        url: https://packages.grafana.com/gpg.key
        state: present

    - name: Add Grafana repository
      ansible.builtin.apt_repository:
        repo: "deb https://packages.grafana.com/oss/deb stable main"
        state: present

    - name: Install Grafana
      ansible.builtin.apt:
        name: grafana
        state: present
        update_cache: true

    - name: Configure Grafana
      ansible.builtin.lineinfile:
        path: /etc/grafana/grafana.ini
        regexp: "^;?{{ item.key }}"
        line: "{{ item.key }} = {{ item.value }}"
        state: present
      loop:
        - { key: 'http_port', value: '{{ grafana_port }}' }
        - { key: 'domain', value: '{{ ansible_fqdn }}' }
      notify: Restart grafana

    - name: Enable and start Grafana
      ansible.builtin.service:
        name: grafana-server
        state: started
        enabled: true

    - name: Allow Grafana port through firewall
      community.general.ufw:
        rule: allow
        port: "{{ grafana_port }}"
        proto: tcp

  handlers:
    - name: Restart grafana
      ansible.builtin.service:
        name: grafana-server
        state: restarted

  post_tasks:
    - name: Wait for Grafana to be ready
      ansible.builtin.uri:
        url: "http://localhost:{{ grafana_port }}/api/health"
        method: GET
        status_code: 200
      register: grafana_health
      until: grafana_health.status == 200
      retries: 5
      delay: 10

    - name: Display Grafana access information
      ansible.builtin.debug:
        msg:
          - "Grafana is available at: http://{{ ansible_default_ipv4.address }}:{{ grafana_port }}"
          - "Default credentials: {{ grafana_admin_user }} / {{ grafana_admin_password }}"
          - "IMPORTANT: Change the default password immediately!"
