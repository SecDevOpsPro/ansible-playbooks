---
# Ubuntu Security Hardening Playbook
# Description: CIS Ubuntu Benchmark compliance and security hardening
# Tested on: Ubuntu 20.04/22.04
# Author: SecDevOpsPro
# Reference: CIS Ubuntu Linux 22.04 LTS Benchmark v1.0.0

- name: Ubuntu Security Hardening (CIS Benchmark)
  hosts: all
  become: true
  gather_facts: true

  vars:
    # SSH hardening
    ssh_port: 22
    ssh_permit_root_login: "no"
    ssh_password_authentication: "no"
    ssh_pubkey_authentication: "yes"
    ssh_max_auth_tries: 3
    ssh_max_sessions: 10

    # Firewall
    ufw_enabled: true
    ufw_default_incoming: deny
    ufw_default_outgoing: allow

    # Fail2ban
    fail2ban_enabled: true
    fail2ban_bantime: 3600
    fail2ban_maxretry: 5

    # Automatic updates
    unattended_upgrades_enabled: true

    # Audit logging
    auditd_enabled: true

  pre_tasks:
    - name: Ensure running on Ubuntu
      ansible.builtin.fail:
        msg: "This playbook is designed for Ubuntu systems only"
      when: ansible_distribution != "Ubuntu"

  roles:
    - security

  tasks:
    # 1. Initial Setup
    - name: Update all packages
      ansible.builtin.apt:
        update_cache: true
        upgrade: dist
        autoremove: true
        autoclean: true
    # 2. Filesystem Configuration
    - name: Disable unused filesystems
      ansible.builtin.lineinfile:
        path: /etc/modprobe.d/CIS.conf
        line: "install {{ item }} /bin/true"
        create: true
        mode: '0644'
      loop:
        - cramfs
        - freevxfs
        - jffs2
        - hfs
        - hfsplus
        - udf

    # 3. Configure /tmp
    - name: Mount /tmp with noexec
      ansible.posix.mount:
        path: /tmp
        src: tmpfs
        fstype: tmpfs
        opts: defaults,noexec,nosuid,nodev
        state: mounted

    # 4. SSH hardening
    - name: Configure SSH daemon
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^#?{{ item.key }}"
        line: "{{ item.key }} {{ item.value }}"
        state: present
        validate: 'sshd -t -f %s'
      loop:
        - { key: 'Port', value: '{{ ssh_port }}' }
        - { key: 'PermitRootLogin', value: '{{ ssh_permit_root_login }}' }
        - { key: 'PasswordAuthentication', value: '{{ ssh_password_authentication }}' }
        - { key: 'PubkeyAuthentication', value: '{{ ssh_pubkey_authentication }}' }
        - { key: 'MaxAuthTries', value: '{{ ssh_max_auth_tries }}' }
        - { key: 'MaxSessions', value: '{{ ssh_max_sessions }}' }
        - { key: 'Protocol', value: '2' }
        - { key: 'X11Forwarding', value: 'no' }
        - { key: 'PermitEmptyPasswords', value: 'no' }
        - { key: 'ClientAliveInterval', value: '300' }
        - { key: 'ClientAliveCountMax', value: '0' }
      notify: Restart ssh

    # 5. Install and configure fail2ban
    - name: Install fail2ban
      ansible.builtin.apt:
        name: fail2ban
        state: present

    - name: Configure fail2ban
      ansible.builtin.template:
        src: templates/fail2ban-jail.local.j2
        dest: /etc/fail2ban/jail.local
        owner: root
        group: root
        mode: '0644'
      notify: Restart fail2ban
      when: fail2ban_enabled

    # 6. Configure firewall (UFW)
    - name: Install UFW
      ansible.builtin.apt:
        name: ufw
        state: present

    - name: Configure UFW default incoming policy
      community.general.ufw:
        direction: incoming
        policy: deny

    - name: Configure UFW default outgoing policy
      community.general.ufw:
        direction: outgoing
        policy: allow

    - name: Allow SSH through firewall
      community.general.ufw:
        rule: allow
        port: "{{ ssh_port }}"
        proto: tcp

    - name: Enable UFW
      community.general.ufw:
        state: enabled
      when: ufw_enabled

    # 7. Kernel hardening
    - name: Apply kernel security settings
      ansible.posix.sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        state: present
        sysctl_file: /etc/sysctl.d/99-CIS.conf
        reload: true
      loop:
        - { key: 'net.ipv4.ip_forward', value: '0' }
        - { key: 'net.ipv4.conf.all.send_redirects', value: '0' }
        - { key: 'net.ipv4.conf.default.send_redirects', value: '0' }
        - { key: 'net.ipv4.conf.all.accept_source_route', value: '0' }
        - { key: 'net.ipv4.conf.default.accept_source_route', value: '0' }
        - { key: 'net.ipv4.conf.all.accept_redirects', value: '0' }
        - { key: 'net.ipv4.conf.default.accept_redirects', value: '0' }
        - { key: 'net.ipv4.icmp_echo_ignore_all', value: '0' }
        - { key: 'net.ipv4.icmp_echo_ignore_broadcasts', value: '1' }
        - { key: 'net.ipv4.tcp_syncookies', value: '1' }
        - { key: 'kernel.randomize_va_space', value: '2' }

    # 8. Configure automatic updates
    - name: Install unattended-upgrades
      ansible.builtin.apt:
        name: unattended-upgrades
        state: present

    - name: Configure unattended-upgrades
      ansible.builtin.template:
        src: templates/50unattended-upgrades.j2
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        owner: root
        group: root
        mode: '0644'
      when: unattended_upgrades_enabled

    # 9. Audit logging
    - name: Install auditd
      ansible.builtin.apt:
        name: auditd
        state: present

    - name: Enable auditd
      ansible.builtin.service:
        name: auditd
        state: started
        enabled: true
      when: auditd_enabled

    # 10. Set proper permissions
    - name: Set permissions on sensitive files
      ansible.builtin.file:
        path: "{{ item }}"
        mode: '0600'
        owner: root
        group: root
      loop:
        - /etc/ssh/sshd_config
        - /etc/shadow
        - /etc/gshadow

  handlers:
    - name: Restart ssh
      ansible.builtin.service:
        name: sshd
        state: restarted

    - name: Restart fail2ban
      ansible.builtin.service:
        name: fail2ban
        state: restarted

  post_tasks:
    - name: Display security status
      ansible.builtin.debug:
        msg:
          - "SSH hardened: âœ“"
          - "Firewall (UFW): {{ 'enabled' if ufw_enabled else 'disabled' }}"
          - "Fail2ban: {{ 'enabled' if fail2ban_enabled else 'disabled' }}"
          - "Automatic updates: {{ 'enabled' if unattended_upgrades_enabled else 'disabled' }}"
          - "Audit logging: {{ 'enabled' if auditd_enabled else 'disabled' }}"

    - name: Security hardening complete
      ansible.builtin.debug:
        msg: "Ubuntu security hardening completed successfully. Please reboot the system."
