---
# Multi-Tier Application Deployment Playbook
# Description: Deploy complete infrastructure (LB + App + DB)
# Tested on: Ubuntu 20.04/22.04, Debian 11
# Author: SecDevOpsPro

# Phase 1: Base system setup for all hosts
- name: Base System Configuration
  hosts: all
  become: true
  become_method: ansible.builtin.sudo
  gather_facts: true

  pre_tasks:
    - name: Update APT packages
      ansible.builtin.apt:
        name:
          - busybox
          - python3-pip
          - git-core
          - apt-transport-https
          - colordiff
          - mtr-tiny
          - psmisc
          - rsync
          - curl
          - wget
          - vim
          - htop
        state: present
        update_cache: true
        autoclean: true
        install_recommends: false
      when: ansible_os_family == "Debian"
      tags: packages

  roles:
    - { role: common, tags: ["common"] }
    - { role: firewall, tags: ["firewall"] }
    - { role: security, tags: ["security"] }

  post_tasks:
    - name: Display base setup completion
      ansible.builtin.debug:
        msg: "Base system configuration completed for {{ inventory_hostname }}"

# Phase 2: Database Servers
- name: Setup Database Servers
  hosts: db_servers
  become: true
  become_method: ansible.builtin.sudo
  gather_facts: true

  pre_tasks:
    - name: Ensure PyMySQL module is installed
      ansible.builtin.pip:
        name:
          - PyMySQL
          - cryptography
        state: present
      tags: packages

  roles:
    - { role: mysql, tags: ["database", "mysql"] }

  post_tasks:
    - name: Verify MySQL is accessible
      ansible.builtin.command: mysql -e "SELECT VERSION();"
      register: mysql_version
      changed_when: false

    - name: Display MySQL version
      ansible.builtin.debug:
        msg: "MySQL installed: {{ mysql_version.stdout }}"

# Phase 3: Load Balancers
- name: Setup Load Balancers
  hosts: web_servers
  become: true
  become_method: ansible.builtin.sudo
  gather_facts: true

  vars:
    nginx_upstream_servers: "{{ groups['app_servers'] | default([]) }}"

  roles:
    - { role: nginx, tags: ["loadbalancer", "nginx"] }

  tasks:
    - name: Configure NGINX as load balancer
      ansible.builtin.template:
        src: templates/nginx-loadbalancer.conf.j2
        dest: /etc/nginx/sites-available/loadbalancer
        owner: root
        group: root
        mode: '0644'
      notify: Reload nginx
      when: nginx_upstream_servers | length > 0

    - name: Enable load balancer configuration
      ansible.builtin.file:
        src: /etc/nginx/sites-available/loadbalancer
        dest: /etc/nginx/sites-enabled/loadbalancer
        state: link
      notify: Reload nginx
      when: nginx_upstream_servers | length > 0

  post_tasks:
    - name: Verify NGINX configuration
      ansible.builtin.command: nginx -t
      register: nginx_test
      changed_when: false

    - name: Display load balancer status
      ansible.builtin.debug:
        msg: "Load balancer configured with {{ nginx_upstream_servers | length }} upstream servers"

# Phase 4: Application Servers
- name: Deploy Application Servers
  hosts: app_servers
  become: true
  become_method: ansible.builtin.sudo
  gather_facts: true

  vars:
    app_name: "myapp"
    app_port: 8080
    db_host: "{{ groups['db_servers'][0] }}"

  tasks:
    - name: Install application runtime
      ansible.builtin.apt:
        name:
          - python3
          - python3-pip
          - python3-venv
        state: present
      when: ansible_os_family == "Debian"

    - name: Create application user
      ansible.builtin.user:
        name: "{{ app_name }}"
        system: true
        shell: /bin/bash
        create_home: true

    - name: Create application directory
      ansible.builtin.file:
        path: "/opt/{{ app_name }}"
        state: directory
        owner: "{{ app_name }}"
        group: "{{ app_name }}"
        mode: '0755'

    - name: Allow application port through firewall
      community.general.ufw:
        rule: allow
        port: "{{ app_port }}"
        proto: tcp
        from_ip: "{{ item }}"
      loop: "{{ groups['web_servers'] | map('extract', hostvars, 'ansible_default_ipv4') | map(attribute='address') | list }}"

  post_tasks:
    - name: Display application deployment status
      ansible.builtin.debug:
        msg:
          - "Application: {{ app_name }}"
          - "Port: {{ app_port }}"
          - "Database: {{ db_host }}"

# Phase 5: Verification
- name: Verify Multi-Tier Deployment
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "=== Multi-Tier Deployment Summary ==="
          - "Load Balancers: {{ groups['web_servers'] | join(', ') }}"
          - "Application Servers: {{ groups['app_servers'] | join(', ') }}"
          - "Database Servers: {{ groups['db_servers'] | join(', ') }}"
          - ""
          - "Deployment completed successfully!"
          - "Access your application at: http://{{ groups['web_servers'][0] }}"
